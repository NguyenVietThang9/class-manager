{% extends "base.html" %}
{% block content %}

<!-- ===== NAV ===== -->
<div class="nav">
    <a href="/" class="home-link">
        <i class="fa-solid fa-house-heart"></i> Trang thÃ¡ng
    </a>

    <select class="group-switch"
            onchange="location.href=this.value">
        {% for g in groups %}
        <option value="/month/{{ month }}/{{ g.id }}"
            {% if g.id == group_id %}selected{% endif %}>
            {{ g.name }}
        </option>
        {% endfor %}
    </select>

    <a class="excel"
       href="/export_excel/{{ month }}/{{ group_id }}">
        <i class="fa-solid fa-file-excel"></i> Excel nhÃ³m
    </a>
</div>

<h2 class="month-title">
    ğŸ’— ThÃ¡ng {{ month }} â€“ {{ group.name }}
</h2>

<!-- ===== Há»ŒC SINH + NGÃ€Y Dáº Y ===== -->
<div class="card">

    <h3>ğŸ‘§ğŸ‘¦ Há»c sinh</h3>

    <form class="form-inline"
          method="post"
          action="/add_student">

        <input type="hidden" name="month" value="{{ month }}">
        <input type="hidden" name="group_id" value="{{ group_id }}">

        <input name="name"
               placeholder="ğŸ‘¤ TÃªn há»c sinh"
               required>

        <input type="number"
               name="fee"
               placeholder="ğŸ’° Há»c phÃ­ / buá»•i"
               required>

        <select name="student_id">
            <option value="">ğŸ—‘ Chá»n há»c sinh</option>
            {% for row in rows %}
            <option value="{{ row.student.id }}">
                {{ row.student.name }}
            </option>
            {% endfor %}
        </select>

        <button type="submit" class="btn">
            <i class="fa-solid fa-circle-plus"></i>
        </button>

        <button type="submit"
                class="btn danger"
                formaction="/delete_student_select/{{ month }}/{{ group_id }}"
                formmethod="get"
                onclick="return confirm('XÃ³a há»c sinh?')">
            <i class="fa-solid fa-trash"></i>
        </button>
    </form>


    <h3>ğŸ“… NgÃ y dáº¡y</h3>

    <form class="form-inline"
          method="post"
          action="/add_lesson">

        <input type="hidden" name="month" value="{{ month }}">
        <input type="hidden" name="group_id" value="{{ group_id }}">

        <input type="date"
               name="lesson_date"
               required>

        <select name="lesson_id">
            <option value="">ğŸ—‘ Chá»n ngÃ y</option>
            {% for l in lessons %}
            <option value="{{ l.id }}">
                {{ l.lesson_date[8:] }}/{{ l.lesson_date[5:7] }}
            </option>
            {% endfor %}
        </select>

        <button type="submit" class="btn">
            <i class="fa-solid fa-circle-plus"></i>
        </button>

        <button type="submit"
                class="btn danger"
                formaction="/delete_lesson_select/{{ month }}/{{ group_id }}"
                formmethod="get"
                onclick="return confirm('XÃ³a ngÃ y dáº¡y?')">
            <i class="fa-solid fa-trash"></i>
        </button>
    </form>

</div>



<!-- ===== Báº¢NG ÄIá»‚M DANH + Há»ŒC PHÃ ===== -->
<table class="main-table">
    <tr>
        <th>ğŸ‘©â€ğŸ“ TÃªn</th>

        {% for l in lessons %}
        <th>
            {{ l.lesson_date[8:] }}/{{ l.lesson_date[5:7] }}
        </th>
        {% endfor %}

        <th>ğŸ“Š Sá»‘ buá»•i</th>
        <th>ğŸ’° Há»c phÃ­</th>
        <th>Thu tiá»n</th>
    </tr>

    {% for row in rows %}
    <tr>
        <td class="name">
            {{ row.student.name }}
        </td>

        {% for l in lessons %}
        <td class="cell"
            onclick="toggle({{ row.student.id }}, {{ l.id }})">
            {% if row.attendance[loop.index0] %}
                ğŸ’—
            {% endif %}
        </td>
        {% endfor %}

        <td><b>{{ row.total }}</b></td>
        <td class="money">{{ row.money }}.000</td>

        <!-- Cá»˜T TÃCH GIAO DIá»†N -->
        <td style="text-align:center;">
            <span class="paid-icon"
                  onclick="toggleIcon(this)"
                  style="
                    background:#dc3545;
                    color:white;
                    padding:6px 12px;
                    border-radius:50px;
                    font-weight:bold;
                    cursor:pointer;
                    display:inline-block;
                    min-width:30px;">
                âœ—
            </span>
        </td>

    </tr>
    {% endfor %}
</table>


<!-- ===== Báº¢NG ÄIá»‚M ===== -->
<h3 class="score-title">ğŸ“’ Báº¢NG ÄIá»‚M</h3>

<table class="score-table">
    <tr>
        <th>TÃªn</th>

        {% for t in titles %}
        <th>{{ t.title }}</th>
        {% endfor %}

        <th>
            <button type="button"
                    class="btn small"
                    onclick="addTitle()">
                â•
            </button>
        </th>
    </tr>

    {% for row in rows %}
    <tr>
        <td class="name">
            {{ row.student.name }}
        </td>

        {% for t in titles %}
        <td>
            <input type="number"
                   step="0.1"
                   class="score-input"
                   value="{{ row.scores[t.id] }}"
                   onblur="saveScore({{ row.student.id }}, {{ t.id }}, this.value)">
        </td>
        {% endfor %}

        <td></td>
    </tr>
    {% endfor %}
</table>


<!-- ===== SCRIPT ===== -->
<script>
function toggle(student_id, lesson_id){
    fetch("/toggle",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            student_id:student_id,
            lesson_id:lesson_id
        })
    }).then(()=>location.reload());
}

function addTitle(){
    let title = prompt("Nháº­p tiÃªu Ä‘á» cá»™t Ä‘iá»ƒm");
    if(!title) return;

    fetch("/add_score_title",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            title:title,
            month:{{ month }},
            group_id:{{ group_id }}
        })
    }).then(()=>location.reload());
}

function saveScore(student_id, title_id, score){
    fetch("/save_score",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            student_id:student_id,
            title_id:title_id,
            score:score
        })
    });
}

/* ===== TOGGLE ICON THU TIá»€N (CHá»ˆ GIAO DIá»†N) ===== */
function toggleIcon(el){
    if(el.innerHTML.trim() === "âœ—"){
        el.innerHTML = "âœ“";
        el.style.background = "#28a745";
    }else{
        el.innerHTML = "âœ—";
        el.style.background = "#dc3545";
    }
}
</script>

{% endblock %}
